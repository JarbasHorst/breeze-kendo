!function(e,t,r){"use strict";function n(e,t){if(!e.manager)throw new Error("Please specify a Breeze EntityManager via `manager` option");if(!e.query)throw new Error("Please specify a Breeze EntityQuery via `query` option");this.manager=e.manager,this.query=e.query,this.useBreezeMapping=e.useBreezeMapping,this.scheduler=e.scheduler,this.kendoModelType=t,this.useBreezeMapping&&(this.breezeEntityMapping=Object.create(null))}function a(e){return{eq:h.Equals,neq:h.NotEquals,lt:h.LessThan,lte:h.LessThanOrEqual,gt:h.GreaterThan,gte:h.GreaterThanOrEqual,startswith:h.StartsWith,endswith:h.EndsWith,contains:h.Contains}[e]}function i(e){var t=e.filters.map(function(e){var t="tolower("+e.field+")",r=a(e.operator),n=e.value;return l.create(t,r,n)});if("and"===e.logic)return l.and(t);if("or"===e.logic)return l.or(t);throw new Error("Unsupported predicate logic "+e.logic)}function s(e,t,r){var n;for(n in e)e.hasOwnProperty(n)&&("object"==typeof e[n]?s(e[n],t,(r||"")+n+"."):t(e,(r||"")+n))}function o(){var e=!1;return function(t){return function(){if(!e){e=!0;try{t.apply(this,arguments)}finally{e=!1}}}}}function c(e,t,r,n){var a=o();e.bind({change:a(function(r){r.field?t[r.field]=e[r.field]:console&&console.error&&console.error("Unhandled ObservableObject->Breeze change event",r)})}),t.entityAspect.propertyChanged.subscribe(a(function(t){t.propertyName?e.set(t.propertyName,t.newValue):t.entity&&s(t.entity._backingStore,function(t,r){e.set(r,t[r])})})),r?n[e.id]=t:e.__breezeEntity=t}var u=t.data.breeze={},l=r.Predicate,h=r.FilterQueryOp;e.extend(n.prototype,{read:function(e){var t,r,n,a,s=this,o=s.query,c=e.data;c.filter&&(o=o.where(i(c.filter))),s.scheduler&&(t=s.scheduler.getKendoScheduler(),t&&(r=t.view(),n=r.startDate(),a=r.endDate(),o=o.where(l.or([l.create("recurs",h.Equals,!0),l.create("end",h.GreaterThanOrEqual,n),l.create("start",h.LessThanOrEqual,a)])))),c.sort&&c.sort.length>0&&(o=o.orderBy(c.sort.map(function(e){return e.field+("desc"===e.dir?" desc":"")}).join(", "))),c.page&&(o=o.skip(c.skip).take(c.take).inlineCount());try{s.manager.executeQuery(o,function(t){e.success(s._makeResults(t))},function(t){e.error(t)})}catch(u){console.error(u)}},create:function(e){var t=this._handleError;this._saveChanges().then(function(t){e.success(t.httpResponse)})["catch"](function(r){t(e,r)})},update:function(e){var t=this._handleError;this._saveChanges().then(function(t){e.success(t.httpResponse)})["catch"](function(r){t(e,r)})},destroy:function(e){var t=this._handleError;this._saveChanges().then(function(t){e.success(t.httpResponse)})["catch"](function(r){t(e,r)})},_handleError:function(e,t){e.error(t.httpResponse,t.statusText||t.innerError&&t.innerError.statusText)},_saveChanges:function(){var e=null;return function(){var t=this,n=r.Q.defer();return clearTimeout(e),setTimeout(function(){t.manager.saveChanges().then(function(e){n.resolve(e)})["catch"](function(e){n.reject(e)})},10),n.promise}}(),_cancelChanges:function(e){var t,r=this.manager,n=this.useBreezeMapping,a=this.breezeEntityMapping;e?(t=n?a[e.id]:e.__breezeEntity,t&&t.entityManager?t.entityAspect.rejectChanges():r.rejectChanges()):r.rejectChanges()},_makeResults:function(e){var r,n,a,i,s,o,u=this.manager,l=this.query,h=this.kendoModelType,d=this.useBreezeMapping,p=this.breezeEntityMapping;try{r=u.metadataStore,n=r.getEntityTypeNameForResourceName(l.resourceName),a=r.getEntityType(n||l.resourceName)}catch(f){return e.results.total=e.inlineCount,e.results}return i=this._makeSchema(),s=a.dataProperties,o=e.results.map(function(e){var t,r={};return s.forEach(function(t){r[t.name]=e[t.name]}),i&&i.model?(t=h.define(i.model),r=new t(r)):r=new h(r),c(r,e,d,p),r}),o=new t.data.ObservableArray(o),o.bind("change",function(e){switch(e.action){case"remove":e.items.forEach(function(e){d?p[e.id].entityAspect.setDeleted():e.__breezeEntity.entityAspect.setDeleted()});break;case"add":e.items.forEach(function(e){var t=u.createEntity(n||l.resourceName,e);u.addEntity(t),c(e,t,d,p)})}}),o.total=e.inlineCount,o},_makeSchema:function(){var e,t,r,n,a,i={total:function(e){return e.total}};try{e=this.manager.metadataStore,t=e.getEntityTypeNameForResourceName(this.query.resourceName),r=e.getEntityType(t||this.query.resourceName)}catch(s){return i}n={fields:{}},r.keyProperties&&(1===r.keyProperties.length?n.id=r.keyProperties[0].name:r.keyProperties.length>1&&console&&console.error&&console.error("Multiple-key ID not supported"));try{r.dataProperties.forEach(function(e){a="string",e.dataType.isNumeric?a="number":e.dataType.isDate?a="date":"Boolean"===e.dataType.name&&(a="boolean"),n.fields[e.name]={type:a,defaultValue:e.defaultValue,nullable:e.isNullable,required:e.isNullable}})}catch(s){return i}return i.model=n,i}}),u.Source=t.data.DataSource.extend({init:function(r){var a=new n(r,t.data.Model);r=e.extend({},{transport:a,schema:a._makeSchema(),batch:!0},r),t.data.DataSource.prototype.init.call(this,r)},cancelChanges:function(e){var r=this;e instanceof t.data.Model?(r._cancelModel(e),r.transport._cancelChanges(e)):(r._destroyed=[],r._detachObservableParents(),r._data=r._observe(r._pristineData),r.options.serverPaging&&(r._total=r._pristineTotal),r._change(),r.transport._cancelChanges())}}),u.SchedulerSource=t.data.SchedulerDataSource.extend({init:function(r){var a;r=e.extend({},{useBreezeMapping:!0},r),a=new n(r,t.data.SchedulerEvent),r=e.extend({},{transport:a,schema:a._makeSchema(),batch:!0},r),t.data.SchedulerDataSource.prototype.init.call(this,r)},cancelChanges:function(e){var r=this;e instanceof t.data.SchedulerEvent?(r._cancelModel(e),r.transport._cancelChanges(e)):(r._destroyed=[],r._detachObservableParents(),r._data=r._observe(r._pristineData),r.options.serverPaging&&(r._total=r._pristineTotal),r._change(),r.transport._cancelChanges())},_createNewModel:function(e){var r=t.data.SchedulerDataSource.prototype._createNewModel.call(this,e);return r.title="",r.recurrenceId=0,r.recurs=!1,r.isAllDay=!1,r}})}(jQuery,kendo,breeze);
//# sourceMappingURL=breeze-kendo.min.js.map
